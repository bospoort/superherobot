# ContentModerationBot

## Introduction
This bot uses two Cognitive Services APIs: face recognition and content moderation. You can create a list of faces of known people. By default, there is a list of tech company execs. The bot allows you to submit a picture. Before comparing the picture to the entries of known people on the list, it uses the Content Moderation APIs for flagging inappropriate content. You can use either the simple content moderation APIs to analyze individual pictures or the review API with the Review UI. This Review Studio allows human beings to manually evaluate pictures and flag appropriately. When a human resource has the picture reviewed, Content Moderator Review invokes your callback to notify you of the results. 

## Setting it up
You will need to create a .env file with the following keys. See below for instructions, where to get the values. 

``` JSON
cm_id   = {Id obtained from credentials page in https://contentmoderator.cognitive.microsoft.com/}
cm_key  = {Key obtained from credentials page in https://contentmoderator.cognitive.microsoft.com/}
ocp_key = {Key obtained from Cognitive services resource in portal.azure.com}

storageAccountName  = {Azure storage account}
storageAccountKey   = {Azure storage key}

faceAPIkey  = {faceapikey. Key obtained from Cognitive services resource in portal.azure.com}

MICROSOFT_APP_ID        = {bot app id from dev.botframework.com}
MICROSOFT_APP_PASSWORD  = {bot password from dev.botframework.com}

#moderation or review
moderationMode=review
```

First you'll need actual Content Moderation keys: 
1. Go to [Azure Portal](https://portal.azure.com) 
2. Click on the '+' sign to create a new resource
3. Search for 'Cognitive Services' and create the resource
4. In the following API type drop down, select 'Content Moderator'
5. Create appropriate resource groups and and other settings for this account.
6. Go to keys and copy one of the values into ocp_key in .env above  

You will also need a Face API key. 
1. Go through the same steps as above, but select Face API under step 4.  
6. Go to keys and copy one of the values into faceAPIkey in .env above.   

Next, you need to create a storage account. This is used to store the images that your users submit to the bot. 
1. Click on the '+' sign to create a new resource
3. Search for 'Storage Account', select 'Microsoft Storage' and click create 
4. Give it a name, and other settings (default is fine)
5. Create appropriate resource groups and and other settings for this account.
6. Copy the Storage account name and one of the keys into storageAccountName and storageAccountKey

Then you need bot credentials
1. Go to [MBF portal](http://dev.botframework.com)
2. Sign in and create a new bot
3. Copy MICROSOFT_APP_ID and MICROSOFT_APP_PASSWORD to your .env file. 

Finally you need a Content Moderation team site. 
1. Go to [Content Moderator](https://contentmoderator.cognitive.microsoft.com/).  
6. Sign up and provide a default team name.
3. Under the gear, then credentials, you can find the Content Moderator keys. 
4. Copy those to cm_key and cm_id respectively. 

## Getting the callback
Content Moderator needs a callback for pictures when you post them for a job and when someone has reviewed them in the Review UI. When you're developing locally with the MBF emulator, it might be hard to find your IP behind a firewall. You can set up the end point with ngrok: 
```
ngrok http <port>.
```
where <port> is the port you specify in app.js line 15. You will get output similar to this:
```
http://be827c42.ngrok.io
```
I copy that into an environment variable (process.env.WEBSITE_HOSTNAME) in my launch.json file. That same environment variable is the actual web address that Azure populates for my app service once deployed. That fixes up my callback at runtime. 

## Moderation or Review
The bot has two modes: simple moderation or posting jobs to review site. You can control that with the moderationMode flag in .env. 

## Creating your own list
The project has a predefined list of known faces in faceListWithId.json. It is generated by running 

```
node createfacelist.js 
```

from the command line. You can create your own list by modifying the sampleFaces.json file and run the command above. 

## Run the code
You can run the bot and debug with the emulator. It will ask you for a picture. After moderation, it will compare the picture to the list of faces and find the closest match. If you submit an adult picture, moderation will not allow it. When you change the .env setting to Review, you can go to Content Moderator Review UI and change the default workflow with different settings for racy and adult. Or you can create a new workflow and use that. (Change workflowname of the workflow in constants.json). 